<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gibran Storage Center</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;600&display=swap');
        body { font-family: 'Poppins', sans-serif; background: #020617; color: white; margin: 0; padding: 15px; }
        #clock { font-family: 'Orbitron'; font-size: 2rem; text-align: center; color: #00f3ff; margin: 10px 0; }
        .card { background: #1e293b; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #334155; }
        .video-wrap { width: 100%; border-radius: 10px; overflow: hidden; border: 2px solid #00f3ff; background: #000; }
        video { width: 100%; display: block; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-absen { background: #00f3ff; color: #000; }
        .btn-upload { background: #fbbf24; color: #000; }
        
        /* Galeri */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 20px; }
        .item { background: #0f172a; padding: 5px; border-radius: 10px; border: 1px solid #334155; }
        .item img { width: 100%; border-radius: 5px; }
        .btn-del { background: #ef4444; color: white; width: 100%; border: none; padding: 5px; margin-top: 5px; border-radius: 4px; font-size: 10px; }
        .btn-dl { background: #10b981; color: white; width: 100%; border: none; padding: 5px; margin-top: 5px; border-radius: 4px; font-size: 10px; }
    </style>
</head>
<body>

    <div id="clock">00:00:00</div>
    <h3 style="text-align:center; color:#fbbf24;">DASHBOARD GIBRAN</h3>

    <div class="card">
        <div class="video-wrap">
            <video id="v" autoplay playsinline></video>
        </div>
        <button class="btn btn-absen" id="btn-snap">AMBIL FOTO ABSEN</button>
        <canvas id="c" style="display:none;"></canvas>
    </div>

    <div class="card">
        <input type="file" id="up" accept="image/*" multiple style="display:none;">
        <button class="btn btn-upload" onclick="document.getElementById('up').click()">UPLOAD DARI HP</button>
        <button class="btn" style="background:#475569; color:white;" onclick="location.href='index.html'">KEMBALI KE PROFIL</button>
    </div>

    <div class="card">
        <h4 style="margin:0;">STORAGE GALERI</h4>
        <div class="gallery" id="gal"></div>
    </div>

<script>
    const v = document.getElementById('v');
    const c = document.getElementById('c');
    const gal = document.getElementById('gal');
    const up = document.getElementById('up');

    // 1. JAM BERGERAK
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);

    // 2. KAMERA (Wajib HTTPS di GitHub Pages)
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
    .then(s => v.srcObject = s)
    .catch(e => alert("Kamera error/ditolak. Pastikan pake HTTPS!"));

    // 3. LOAD DATA (ANTI-REFRESH)
    function load() {
        const d = JSON.parse(localStorage.getItem('GB_DATA') || '[]');
        gal.innerHTML = ''; // Bersihin dulu
        d.forEach(p => {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `
                <img src="${p.s}">
                <button class="btn-dl" onclick="dl('${p.s}')">SAVE</button>
                <button class="btn-del" onclick="hapus('${p.id}')">HAPUS</button>
            `;
            gal.appendChild(div);
        });
    }
    load();

    // 4. SIMPAN DATA
    function simpan(src) {
        const d = JSON.parse(localStorage.getItem('GB_DATA') || '[]');
        d.push({ id: Date.now().toString(), s: src });
        localStorage.setItem('GB_DATA', JSON.stringify(d));
        load(); // Refresh tampilan galeri
    }

    // 5. EVENT ABSEN
    document.getElementById('btn-snap').onclick = () => {
        c.width = v.videoWidth;
        c.height = v.videoHeight;
        c.getContext('2d').drawImage(v, 0, 0);
        simpan(c.toDataURL('image/png'));
    };

    // 6. EVENT UPLOAD
    up.onchange = (e) => {
        for (let f of e.target.files) {
            const r = new FileReader();
            r.onload = (ev) => simpan(ev.target.result);
            r.readAsDataURL(f);
        }
    };

    // 7. DOWNLOAD & HAPUS
    window.dl = (s) => {
        const l = document.createElement('a');
        l.href = s; l.download = 'Gibran_File.png'; l.click();
    };

    window.hapus = (id) => {
        let d = JSON.parse(localStorage.getItem('GB_DATA') || '[]');
        d = d.filter(x => x.id !== id);
        localStorage.setItem('GB_DATA', JSON.stringify(d));
        load();
    };
</script>
</body>
</html>
